var express = require('express');
var router = express.Router();
var middleware = require('../middleware/auth');
var db = require('../dbconnector');
var jwt = require('jsonwebtoken');
var dotenv = require('dotenv');
require('dotenv').config();

const { decode } = require('jsonwebtoken');



router.post('/create', middleware.authenticateToken, (req, res) => {
        console.log('create task');
        var { title, description, dueDate } = req.body;
        console.log(req.body);
        console.log(title);
        console.log(description);
        console.log(dueDate);
        var sql = 'INSERT INTO tasks (title, description, dueDate) VALUES (?, ?, ?)';
        db.query(sql, [title, description, dueDate], (err, result) => {
                if (err) {
                        console.log('Error creating task');
                        return res.status(500).json({ error: 'Error creating task' });
                }
                console.log('Task created successfully');
                res.redirect('/task/list');
        });
});

router.get('/list', middleware.authenticateToken, (req, res) => {
        console.log('list tasks');

        token = req.cookies.token;
        console.log(token);
        decoded = jwt.verify(token,process.env.ACCESS_TOKEN_SECRET);
        console.log(decoded);
        username = decoded.username;
        console.log(username);

        var sql = 'SELECT task.* FROM task INNER JOIN users ON task.creatorID = users.id WHERE users.username = ?';

        db.query(sql,[username] ,(err, result) => {
                
                if (err) {
                        console.log('Error listing tasks');
                        return res.status(500).json({ error: 'Error listing tasks' });
                }
                console.log('Tasks listed successfully');
                res.json(result);
        });
});

module.exports = router;