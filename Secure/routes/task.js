var express = require('express');
var router = express.Router();
var middleware = require('../middleware/auth');
var db = require('../dbconnector');
var jwt = require('jsonwebtoken');
var dotenv = require('dotenv');
require('dotenv').config();

const { decode } = require('jsonwebtoken');



router.post('/create', middleware.authenticateToken, async (req, res) => {
        console.log('create task');
        var { title, description, dueDate } = req.body;
        console.log(req.body);
        console.log(title);
        console.log(description);
        console.log(dueDate);

        const userId = await middleware.getUserIdFromToken(req.cookies.token);
        console.log("Test " + userId);
        console.log("Bonjour");
        var sql = 'INSERT INTO tasks (creatorId ,title, description, dueDate) VALUES (?, ?, ?, ?)';
        db.query(sql, [userId, title, description, dueDate], (err, result) => {
                if (err) {
                        console.log('Error creating task');
                        console.log(err);
                        return res.status(500).json({ error: 'Error creating task' });
                }
                console.log('Task created successfully');
                res.redirect('/task/list');
        });
});

router.get('/list', middleware.authenticateToken, (req, res) => {
        console.log('list tasks');

        token = req.cookies.token;
        console.log(token);
        decoded = jwt.verify(token,process.env.ACCESS_TOKEN_SECRET);
        console.log(decoded);
        username = decoded.username;
        console.log(username);

        var sql = 'SELECT tasks.* FROM tasks INNER JOIN users ON tasks.creatorID = users.id WHERE users.username = ?';

        db.query(sql,[username] ,(err, result) => {
                
                if (err) {
                        console.log('Error listing tasks');
                        console.log(err);
                        return res.status(500).json({ error: 'Error listing tasks' });
                }
                console.log('Tasks listed successfully');
                console.log(result);
                res.render('tasks', { tasks: result });
        });
});


router.put('/:id', middleware.authenticateToken, (req, res) => {
        console.log('update task');
        var { id } = req.params;
        //var { title, description, dueDate, status } = req.body;
        console.log(id);
});

module.exports = router;